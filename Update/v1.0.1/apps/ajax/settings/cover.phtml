<?php

require_once("../../../core/vipub_web_core.phtml");

if (!isset($_SESSION["user_id"])) {
  vipub_redirect("/welcome/login");
  exit;
}
if(isset($_POST['action']) && $_POST['action'] === 'change-cover') {
  $file_name = $_FILES['cover']['name'];
  $file_tmp = $_FILES['cover']['tmp_name'];
  $file_size = $_FILES['cover']['size'];
  $file_type = $_FILES['cover']['type'];
  $file_ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));

  // İzin verilen dosya türleri
  $allowed = array('jpg', 'jpeg', 'png', 'gif');

  // Dosya türü kontrolü
  if(!in_array($file_ext, $allowed)) {
    http_response_code(400);
    echo 'Sadece JPG, JPEG, PNG ve GIF dosyalarına izin verilir.';
    exit();
  }

  // Dosya boyutu kontrolü (1 MB'tan küçük olmalıdır)
  if($file_size > 1048576) {
    http_response_code(400);
    echo 'Dosya boyutu 1 MB\'dan küçük olmalıdır.';
    exit();
  }

  // Yükleme klasörü
  $upload_dir = '../../../upload/profile/';

  // Eğer yükleme klasörü yoksa oluştur
  if(!is_dir($upload_dir)) {
    mkdir($upload_dir, 0755, true);
  }

  // Yeni dosya adı
  $new_file_name = time() . '_' . uniqid() . '.' . $file_ext;

  // Dosya adını güncelleme
  $new_file_name = preg_replace("/[^\w\-\.]/", '', $new_file_name);
  $new_file_name = substr($new_file_name, 0, 255);

  // Dosyayı kaydet
  if(move_uploaded_file($file_tmp, $upload_dir . $new_file_name)) {
    // Veritabanı güncelleme işlemi
    $user_id = $_SESSION["user_id"];
    $cover_path = $upload_dir . $new_file_name;

    $stmt = $conn->prepare("UPDATE vipub_users SET cover = ? WHERE id = ?");
    $stmt->bind_param("si", $cover_path, $user_id);

    if(!$stmt->execute()) {
      http_response_code(500);
      echo 'Veritabanında güncelleme yapılırken hata oluştu: ' . $conn->error;
      exit();
    }

    $stmt->close();
    $conn->close();

    // Başarılı sonuç
    http_response_code(200);
    echo $cover_path;
  } else {
    http_response_code(500);
    echo 'Dosya yükleme hatası.';
  }
} else {
  http_response_code(400);
  echo 'Geçersiz istek.';
}