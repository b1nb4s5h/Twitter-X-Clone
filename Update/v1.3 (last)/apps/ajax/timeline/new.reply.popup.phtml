<?php
require_once("../../../core/xclone_web_core.phtml");
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;
$smtp_settings = xclone_smtp();

if (!isset($_SESSION["user_id"])) {
  header("Location: /welcome/login");
  exit;
}


if (isset($_POST['reply_post_id'], $_POST['content'])) {
  $reply_post_id = $_POST['reply_post_id'];
  $content = $_POST['content'];
  $userId = $_SESSION['user_id'];
  $p_data_lang = xclone_user_acceptLanguage();
  
  // Güvenlik: Verileri temizleyerek SQL enjeksiyonlarına karşı koruma sağlayın
  $content = mysqli_real_escape_string($conn, $content);
  $reply_post_id = intval($reply_post_id);
  
  saveHashtags($conn, $content);
  
  $query = "INSERT INTO xclone_posts (reply_post_id, user_id, content_post, content_image, post_type, post_lang) VALUES (?, ?, ?, NULL, 'reply', ?)";
  
  $stmt = $conn->prepare($query);
  $stmt->bind_param("iiss", $reply_post_id, $userId, $content, $p_data_lang);
  
  if ($stmt->execute()) {
    // Cevap sayısını güncelle
    $update_query = "UPDATE xclone_posts SET reply = reply + 1 WHERE p_id = ?";
    $update_stmt = $conn->prepare($update_query);
    $update_stmt->bind_param("i", $reply_post_id);
    if ($update_stmt->execute()) {
      // @mention
      $pattern = '/@([a-zA-Z0-9_]+)/';
      preg_match_all($pattern, $content, $matches);
  
      if (!empty($matches[1])) {
        foreach ($matches[1] as $mention) {
          $user_query = "SELECT id FROM xclone_users WHERE username = ?";
          $user_stmt = $conn->prepare($user_query);
          $user_stmt->bind_param("s", $mention);
          $user_stmt->execute();
          $user_result = $user_stmt->get_result();
  
          if ($user_result->num_rows > 0) {
            $user_row = $user_result->fetch_assoc();
            $mentioned_user_id = $user_row['id'];
  
            if ($mentioned_user_id != $userId) {
              $notif_query = "INSERT INTO xclone_notifs (user_id, sender_id, post_id, type) VALUES (?, ?, ?, 'mention_reply')";
              $notif_stmt = $conn->prepare($notif_query);
              $notif_stmt->bind_param("iii", $mentioned_user_id, $userId, $reply_post_id);
              $notif_stmt->execute();
            }
          }
        }
      }
  
      // Yorum yapılan post sahibine bildirim gönder
      $post_owner_query = "SELECT user_id FROM xclone_posts WHERE p_id = ?";
      $post_owner_stmt = $conn->prepare($post_owner_query);
      $post_owner_stmt->bind_param("i", $reply_post_id);
      $post_owner_stmt->execute();
      $post_owner_result = $post_owner_stmt->get_result();
  
      if ($post_owner_result->num_rows > 0) {
        $post_owner_row = $post_owner_result->fetch_assoc();
        $post_owner_id = $post_owner_row['user_id'];
  
        if ($post_owner_id != $userId) {
          $notif_query = "INSERT INTO xclone_notifs (user_id, sender_id, post_id, type) VALUES (?, ?, ?, 'comment')";
          $notif_stmt = $conn->prepare($notif_query);
          $notif_stmt->bind_param("iii", $post_owner_id, $userId, $reply_post_id);
          $notif_stmt->execute();
        }
      }
  
      echo "Reply added successfully";
    } else {
      echo "Error updating reply count: " . mysqli_error($conn);
    }
  } else {
    echo "Error adding reply: " . mysqli_error($conn);
  }
  
  $stmt->close();
  $conn->close();
}